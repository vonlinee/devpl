<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.devpl.backend.dao.DataTypeMappingMapper">

    <select id="listDataTypeMappings" resultType="io.devpl.backend.domain.vo.DataTypeMappingListVO">
        SELECT A.type_id,
        B.locale_type_name,
        B.type_group_id,
        C.locale_type_name AS another_type_name,
        C.type_group_id AS another_group_id
        FROM data_type_mapping A
        LEFT JOIN (SELECT data_type_item.*, data_type_group.group_id, data_type_group.group_name
        FROM data_type_item
        LEFT JOIN data_type_group
        ON data_type_item.type_group_id = data_type_group.group_id) B
        ON A.type_id = B.id
        LEFT JOIN
        (SELECT data_type_item.*, data_type_group.group_id, data_type_group.group_name
        FROM data_type_item
        LEFT JOIN data_type_group
        ON data_type_item.type_group_id = data_type_group.group_id) C
        ON A.another_type_id = C.id
        <where>
            <if test="typeId != null">
                AND A.type_id = #{typeId}
            </if>
        </where>
    </select>
    <select id="selectUnMappedTypeList" resultType="io.devpl.backend.entity.DataTypeItem">
        SELECT dt.id, dt.locale_type_name
        FROM data_type_item dt
                 LEFT JOIN data_type_mapping dtm ON dt.id = dtm.id
        WHERE dtm.id IS NULL
    </select>
    <select id="selectExcludeByTypeId" resultType="io.devpl.backend.entity.DataTypeItem">
        SELECT id, locale_type_name
        FROM data_type_item
        WHERE type_group_id != #{excludeTypeGroupId} /*不在同一组内*/
        <if test="excludeIds != null and excludeIds.size() > 0">
            AND id NOT IN
            <foreach item="item" index="index" collection="excludeIds" open="(" close=")" separator=",">
                #{item}
            </foreach>
            /*过滤已有的映射关系*/
        </if>
    </select>

    <select id="selectMappedDataTypeIds" resultType="long">
        SELECT DISTINCT another_type_id
        FROM data_type_mapping
        WHERE type_id = #{typeId}
        <if test="groupId != null">
            AND group_id = #{groupId}
        </if>
    </select>
</mapper>
